<meta charset="utf-8">
<link href="x3dom.css" rel="stylesheet" />
<script src="x3dom.js"></script>
<script src="jquery.js"></script>
    <x3d id='x3dElement' style='width:100%; height:100%; border:0'        
        onmouseup  ="stopDragging();"
        onmousemove="mouseMoved(event);">
      <scene> 
      
        <!--view and navigation-->        
        <viewpoint position="5.09349 5.61586 13.27088" orientation="-0.71805 0.68885 0.09947 0.51301"></viewpoint>	
        <navigationInfo id="navInfo" type='"EXAMINE" "ANY"' typeParams="-0.4, 60, 0.5, 1.55"></navigationInfo>
      
      
        <!--grid-->
        <transform rotation="1 0 0 -1.57079632679">
            <Shape isPickable="false">
                <Appearance>
                    <Material diffuseColor='0.0 0.0 0.0' specularColor='0.0 0.0 0.0' emissiveColor='0.2 0.2 0.2'></Material>                    
                </Appearance>
                <Plane id="gridPlane" solid="false" size='20 20' primType='LINES' subdivision='20 20'>
                </Plane>
            </Shape>
            <Shape isPickable="false">
                <Appearance>
                    <Material></Material>                    
                </Appearance>
                <IndexedLineSet coordIndex="0 1 2 3 0 -1">
                    <Coordinate id="gridBordersCoordNode" point="-10.0 -10.0 0.0, -10.0 10.0 0.0 ,  10.0 10.0 0.0, 10.0 -10.0 0.0"/>
                    <Color color="0.4 0.4 0.4, 0.4 0.4 0.4, 0.4 0.4 0.4, 0.4 0.4 0.4"/>
                </IndexedLineSet>
            </Shape>
        </transform>
        
        
        <!--axes-->
        <transform translation="0 0.002 0.0">
<group>

			<!-- X arrow and label -->
            <Shape isPickable="false" DEF="AXIS_LINE_X">
                <IndexedLineSet index="0 1 -1">
                    <Coordinate point="0 0 0.001, 15 0 0.001" color="1 0 0, 1 0 0"></Coordinate>
                </IndexedLineSet>

                <Appearance DEF='Red'>
                    <Material diffuseColor="0 0 0" emissiveColor='1 0 0'></Material>
                    <LineProperties linewidthScaleFactor="2.0"></LineProperties>
                </Appearance>
            </Shape>
			<!-- Y arrow and label -->                            
            <Shape isPickable="false" DEF="AXIS_LINE_Y">
            	<IndexedLineSet index="0 1 -1">
            	    <Coordinate point="0 0 0.001, 0 15 0.001" color="0 1 0, 0 1 0"></Coordinate>
            	</IndexedLineSet>

            	<Appearance DEF='Green'>
                    <Material diffuseColor="0 0 0" emissiveColor='0 1 0'></Material>
                    <LineProperties linewidthScaleFactor="2.0"></LineProperties>
                </Appearance>
			</Shape>
			<!-- Z arrow and label -->
            <Shape isPickable="false" DEF="AXIS_LINE_Z">
                <IndexedLineSet index="0 1 -1" >
                    <Coordinate point="0 0 0.001, 0 0 15" color="0 0 1, 0 0 1"></Coordinate>
                </IndexedLineSet>

                <Appearance DEF='Blue'>
                    <Material diffuseColor="0 0 0" emissiveColor='0 0 1'></Material>
                    <LineProperties linewidthScaleFactor="2.0"></LineProperties>
                </Appearance>
            </Shape>

		</group>
        </transform>
        
        <transform translation="0 1 -6" onmousedown="startDragging(this);">
            <shape>
                <appearance>
                    <material diffuseColor="1 0.5 0" specularColor="0.3 0.3 0.3"></material>
                </appearance>
                <cone></cone>
            <shape>
        </transform>
        
        <transform translation="4 0 0" onmousedown="startDragging(this);">
            <shape>
                <appearance>
                    <material diffuseColor="0 0.7 0.5" specularColor="0.3 0.3 0.3"></material>
                </appearance>
                <sphere></sphere>
            <shape>
        </transform>       
        
      </scene>
    </x3d>
<style>
    x3d {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }
</style>
<script>
        var cellSize = 1.0;
        
        var lastMouseX = -1;
        var lastMouseY = -1;
        
        var draggedTransformNode = null;
        
        //vectors in 3D world space, associated to mouse x/y movement on the screen
        var draggingUpVec    = null;
        var draggingRightVec = null;
        
        var unsnappedDragPos = null;
	var snap = false;
        
        //------------------------------------------------------------------------------------------------------------------
        
        var mouseMoved = function(event)
        {
            //offsetX / offsetY polyfill for FF
            var target = event.target || event.srcElement;
            var rect = target.getBoundingClientRect();
            event.offsetX = event.clientX - rect.left;
            event.offsetY = event.clientY - rect.top;
        
            if (lastMouseX === -1)
            {
                lastMouseX = event.offsetX;
            }
            if (lastMouseY === -1)
            {
                lastMouseY = event.offsetY;
            }

            if (draggedTransformNode)
            {
               dragObject(event.offsetX - this.lastMouseX, event.offsetY - this.lastMouseY);
            }

            lastMouseX = event.offsetX;
            lastMouseY = event.offsetY;
        };
        
        //------------------------------------------------------------------------------------------------------------------
        
        var startDragging = function(transformNode)
        {        
            //disable navigation during dragging
            document.getElementById("navInfo").setAttribute("type", '"NONE"');
                       
            draggedTransformNode = transformNode;            
            unsnappedDragPos     = new x3dom.fields.SFVec3f.parse(transformNode.getAttribute("translation"));
            
            
            //compute the dragging vectors in world coordinates
            //(since navigation is disabled, those will not change until dragging has been finished)

            //get the viewer's 3D local frame
            var x3dElem  = document.getElementById("x3dElement");
            var vMatInv  = x3dElem.runtime.viewMatrix().inverse();            
            var viewDir  = vMatInv.multMatrixVec(new x3dom.fields.SFVec3f(0.0, 0.0, -1.0));
            
            //use the viewer's up-vector and right-vector
            draggingUpVec    = vMatInv.multMatrixVec(new x3dom.fields.SFVec3f(0.0, 1.0,  0.0));;
            draggingRightVec = viewDir.cross(this.draggingUpVec);   

            
            //project a world unit to the screen to get its size in pixels            
            var x3dElem  = document.getElementById("x3dElement");
            var p1 = x3dElem.runtime.calcCanvasPos(unsnappedDragPos.x, unsnappedDragPos.y, unsnappedDragPos.z);
            var p2 = x3dElem.runtime.calcCanvasPos(unsnappedDragPos.x + draggingRightVec.x,
                                                   unsnappedDragPos.y + draggingRightVec.y,
                                                   unsnappedDragPos.z + draggingRightVec.z)
            var magnificationFactor = 1.0 / Math.abs(p1[0] - p2[0]);
            
            //scale up vector and right vector accordingly            
            draggingUpVec    = draggingUpVec.multiply(magnificationFactor);
            draggingRightVec = draggingRightVec.multiply(magnificationFactor);            
        };

        //------------------------------------------------------------------------------------------------------------------

        var dragObject = function(dx, dy)
        {
            //scale up vector and right vector accordingly            
            var offsetUp    = draggingUpVec.multiply(-dy);
            var offsetRight = draggingRightVec.multiply(dx);

            unsnappedDragPos = unsnappedDragPos.add(offsetUp).add(offsetRight);

            var snappedDragPos;

            //if enabled, take grid snapping into account
            if (snap)
            {
                snappedDragPos = new x3dom.fields.SFVec3f(cellSize * Math.ceil(unsnappedDragPos.x / cellSize),
                                                          cellSize * Math.ceil(unsnappedDragPos.y / cellSize),
                                                          cellSize * Math.ceil(unsnappedDragPos.z / cellSize));
                draggedTransformNode.setAttribute("translation", snappedDragPos.toString());
            }
            else
            {
                draggedTransformNode.setAttribute("translation", unsnappedDragPos.toString());
            }
        }

        //------------------------------------------------------------------------------------------------------------------

        var stopDragging = function()
        {
            draggedTransformNode = null;                
            draggingUpVec        = null;
            draggingRightVec     = null;
            unsnappedDragPos     = null;
            
            //re-enable navigation after dragging
            document.getElementById("navInfo").setAttribute("type", '"EXAMINE" "ANY"');
        };  
</script>
